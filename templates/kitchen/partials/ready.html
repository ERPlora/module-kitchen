{% load i18n djicons %}

<!-- Header -->
<div class="flex items-center justify-between p-4 pb-0">
    <h2 class="text-lg font-semibold">{% trans "Ready to Serve" %}</h2>
    <button type="button"
            class="btn btn-sm btn-outline"
            hx-get="{% url 'kitchen:ready' %}"
            hx-target="#main-content-area"
            hx-push-url="true"
            title="{% trans 'Refresh' %}">
        {% icon "refresh-outline" %}
    </button>
</div>

<!-- Ready Orders -->
<div class="p-4">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for order in orders %}
        <div class="card" style="border-left: 4px solid var(--color-success);"
             id="ready-order-{{ order.id }}">

            <!-- Order Header -->
            <div class="card-header">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="badge badge-lg color-success">
                            #{{ order.order_number }}
                        </span>
                        {% if order.priority == 'rush' %}
                        <span class="badge color-error badge-sm">{% trans "RUSH" %}</span>
                        {% elif order.priority == 'vip' %}
                        <span class="badge color-warning badge-sm">{% trans "VIP" %}</span>
                        {% endif %}
                    </div>
                    <span class="text-sm text-muted">
                        {{ order.elapsed_minutes }}{% trans "min" %}
                    </span>
                </div>
                <div class="text-sm text-muted mt-1">
                    {% if order.table %}{% icon "grid-outline" css_class="text-xs" %} {% trans "Table" %} {{ order.table_display }}{% endif %}
                    {% if order.waiter %} &middot; {{ order.waiter.name }}{% endif %}
                </div>
            </div>

            <!-- Items Summary -->
            <div class="card-body" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <div class="list" style="margin: -0.25rem 0;">
                    {% for item in order.items.all %}
                    {% if not item.is_deleted %}
                    <div class="list-item" style="padding: 0.3rem 0; min-height: auto;">
                        <div class="list-item-start" style="min-width: 28px;">
                            <span class="font-bold text-success">{{ item.quantity }}x</span>
                        </div>
                        <div class="list-item-content" style="padding: 0;">
                            <div class="text-sm">{{ item.product_name }}</div>
                            {% if item.modifiers %}
                            <div class="text-xs text-muted">{{ item.modifiers }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

                {% if order.notes %}
                <div class="mt-2 p-2 rounded-lg" style="background: var(--color-warning-bg, rgba(255,193,7,0.1));">
                    <p class="text-xs text-warning">{% icon "alert-circle-outline" css_class="text-xs" %} {{ order.notes }}</p>
                </div>
                {% endif %}
            </div>

            <!-- Actions -->
            <div class="card-body flex gap-2" style="padding-top: 0.5rem; border-top: 1px solid var(--color-base-300);">
                <button type="button" class="btn btn-sm flex-1"
                        style="background: var(--color-success); color: white;"
                        onclick="serveOrder('{{ order.id }}')">
                    {% icon "restaurant-outline" %} {% trans "Served" %}
                </button>
                <button type="button" class="btn btn-sm btn-outline"
                        hx-get="{% url 'kitchen:order_detail' order.id %}"
                        hx-target="#main-content-area"
                        hx-push-url="true"
                        title="{% trans 'Details' %}">
                    {% icon "ellipsis-horizontal-outline" %}
                </button>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full">
            <div class="card">
                <div class="card-body p-8 text-center">
                    {% icon "hourglass-outline" css_class="text-5xl text-muted mb-3" %}
                    <h3 class="text-lg font-semibold mb-1">{% trans "No Ready Orders" %}</h3>
                    <p class="text-muted mb-4">{% trans "Orders will appear here when they are ready to serve." %}</p>
                    <a hx-get="{% url 'kitchen:display' %}"
                       hx-target="#main-content-area"
                       hx-push-url="true"
                       class="btn btn-outline">
                        {% icon "tv-outline" %} {% trans "View Display" %}
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Auto-refresh every 10s -->
<div hx-get="{% url 'kitchen:ready' %}"
     hx-target="#main-content-area"
     hx-trigger="every 10s"
     hx-swap="innerHTML"
     style="display:none;"></div>

<script>
function serveOrder(orderId) {
    fetch(`{% url 'kitchen:serve_order' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', orderId), {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
    }).then(r => r.json()).then(data => {
        if (data.success) {
            htmx.ajax('GET', '{% url "kitchen:ready" %}', '#main-content-area');
        }
    });
}
</script>
